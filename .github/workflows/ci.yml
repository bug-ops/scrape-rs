name: CI

on:
  push:
    branches: [main, develop]
  pull_request:

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  CARGO_HOME: ${{ github.workspace }}/.cargo
  CARGO_INCREMENTAL: 0
  CACHE_ON_FAILURE: false

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions (principle of least privilege)
permissions:
  contents: read

jobs:
  # ==========================================================================
  # Detect changed paths to enable conditional job execution
  # ==========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      rust: ${{ steps.filter.outputs.rust }}
      python: ${{ steps.filter.outputs.python }}
      node: ${{ steps.filter.outputs.node }}
      wasm: ${{ steps.filter.outputs.wasm }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            rust:
              - 'crates/scrape-core/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - 'rust-toolchain.toml'
              - 'Makefile.toml'
            python:
              - 'crates/scrape-py/**'
            node:
              - 'crates/scrape-node/**'
            wasm:
              - 'crates/scrape-wasm/**'
            ci:
              - '.github/workflows/**'

  # ==========================================================================
  # PARALLEL STAGE 1: Quick checks (run concurrently)
  # ==========================================================================

  fmt:
    name: Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [changes]
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-make
      - run: cargo make fmt-check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes]
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-make
      - run: cargo make clippy

  security:
    name: Security
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes]
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@v6
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny,cargo-make
      - run: cargo make deny

  msrv:
    name: MSRV
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [changes]
    if: needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@v6
      - name: Extract MSRV
        id: msrv
        run: |
          MSRV=$(grep '^rust-version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$MSRV" >> $GITHUB_OUTPUT
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ steps.msrv.outputs.version }}
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: msrv
      - run: cargo check --workspace

  # ==========================================================================
  # STAGE 2: Tests (depends on fmt + clippy passing)
  # ==========================================================================

  test:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    needs: [changes, fmt, clippy]
    if: |
      always() &&
      (needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true') &&
      needs.fmt.result == 'success' &&
      needs.clippy.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: test-${{ matrix.os }}
      - uses: taiki-e/install-action@v2
        with:
          tool: nextest,cargo-make
      - run: cargo make test
      - name: Check benchmarks compile
        if: matrix.os == 'ubuntu-latest'
        run: cargo build --release --benches

  # ==========================================================================
  # STAGE 2 (parallel): Bindings (run in parallel with Rust tests)
  # ==========================================================================

  build-python:
    name: Python ${{ matrix.python-version }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    needs: [changes, fmt, clippy]
    if: |
      always() &&
      needs.fmt.result == 'success' &&
      needs.clippy.result == 'success' &&
      (needs.changes.outputs.python == 'true' || needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true')
    strategy:
      fail-fast: false
      matrix:
        # Full version matrix on Linux, single version on macOS/Windows
        include:
          - { os: ubuntu-latest, python-version: "3.10" }
          - { os: ubuntu-latest, python-version: "3.11" }
          - { os: ubuntu-latest, python-version: "3.12" }
          - { os: ubuntu-latest, python-version: "3.13" }
          - { os: ubuntu-latest, python-version: "3.14" }
          - { os: macos-latest, python-version: "3.12" }
          - { os: windows-latest, python-version: "3.12" }
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: python-${{ matrix.os }}-${{ matrix.python-version }}
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
      - uses: astral-sh/setup-uv@v7
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-make
      - name: Build and test
        working-directory: crates/scrape-py
        run: |
          uv sync
          uv run maturin develop
          uv run ruff check .
          uv run ruff format --check .
          uv run pytest

  build-node:
    name: Node.js ${{ matrix.node-version }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    needs: [changes, fmt, clippy]
    if: |
      always() &&
      needs.fmt.result == 'success' &&
      needs.clippy.result == 'success' &&
      (needs.changes.outputs.node == 'true' || needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true')
    strategy:
      fail-fast: false
      matrix:
        # Full version matrix on Linux, single version on macOS/Windows
        include:
          - { os: ubuntu-latest, node-version: "22" }
          - { os: ubuntu-latest, node-version: "24" }
          - { os: ubuntu-latest, node-version: "25" }
          - { os: macos-latest, node-version: "24" }
          - { os: windows-latest, node-version: "24" }
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: node-${{ matrix.os }}-${{ matrix.node-version }}
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-make
      - name: Build and test
        working-directory: crates/scrape-node
        run: |
          pnpm install --no-frozen-lockfile
          pnpm exec biome check .
          pnpm run build
          pnpm test

  build-wasm:
    name: WASM (${{ matrix.browser }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: [changes, fmt, clippy]
    if: |
      always() &&
      needs.fmt.result == 'success' &&
      needs.clippy.result == 'success' &&
      (needs.changes.outputs.wasm == 'true' || needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true')
    strategy:
      fail-fast: false
      matrix:
        # Safari excluded: WebDriver unreliable in CI (tested locally)
        include:
          - browser: chrome
            os: ubuntu-latest
          - browser: firefox
            os: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: wasm-${{ matrix.browser }}
      - uses: actions/setup-node@v4
        with:
          node-version: "24"
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-make
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      - name: Build and lint
        if: matrix.browser == 'chrome'
        working-directory: crates/scrape-wasm
        run: |
          pnpm install --no-frozen-lockfile
          pnpm exec biome check js/
      - name: Install dependencies
        if: matrix.browser != 'chrome'
        working-directory: crates/scrape-wasm
        run: pnpm install --no-frozen-lockfile
      - name: Build WASM
        run: cargo make wasm-build
      - name: Test WASM
        run: wasm-pack test --headless --${{ matrix.browser }} crates/scrape-wasm

  # ==========================================================================
  # STAGE 2 (parallel): Coverage (runs in parallel with tests)
  # ==========================================================================

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [changes, fmt, clippy]
    if: |
      always() &&
      needs.fmt.result == 'success' &&
      needs.clippy.result == 'success' &&
      (needs.changes.outputs.rust == 'true' || needs.changes.outputs.ci == 'true')
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: coverage
      - uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov
      - name: Generate coverage
        run: cargo llvm-cov --workspace --lcov --output-path lcov.info
      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: lcov.info
          flags: rust
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
