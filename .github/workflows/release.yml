name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUST_BACKTRACE: short
  RUSTUP_MAX_RETRIES: 10

permissions:
  contents: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ==========================================================================
  # Validate tag and extract version
  # ==========================================================================
  validate:
    name: Validate Release Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6

      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION"

      - name: Verify version matches Cargo.toml
        run: |
          CARGO_VERSION=$(grep -m 1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          TAG_VERSION="${{ steps.version.outputs.version }}"
          if [ "$CARGO_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Cargo.toml version ($CARGO_VERSION) does not match tag version ($TAG_VERSION)"
            exit 1
          fi
          echo "Version validation successful: $TAG_VERSION"

  # ==========================================================================
  # Publish to crates.io using Trusted Publishing (OIDC)
  # Setup: https://doc.rust-lang.org/cargo/reference/registry-authentication.html#trusted-publishing
  # ==========================================================================
  publish-crates:
    name: Publish to crates.io
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: release

      - name: Run tests
        run: |
          cargo test -p scrape-core --all-features
          cargo test -p scrape-cli

      - name: Run clippy
        run: |
          cargo clippy -p scrape-core --all-features -- -D warnings
          cargo clippy -p scrape-cli -- -D warnings

      - name: Authenticate with crates.io (Trusted Publishing)
        id: crates-io-auth
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish to crates.io
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ steps.crates-io-auth.outputs.token }}
          ignore-unpublished-changes: true
          publish-delay: 10000

  # ==========================================================================
  # Build CLI binaries for multiple platforms
  # ==========================================================================
  build-cli:
    name: Build CLI (${{ matrix.platform.name }})
    needs: validate
    runs-on: ${{ matrix.platform.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive: tar.gz

          - name: linux-aarch64
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            archive: tar.gz

          - name: darwin-x86_64
            os: macos-14
            target: x86_64-apple-darwin
            archive: tar.gz

          - name: darwin-aarch64
            os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.gz

          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: cli-${{ matrix.platform.name }}

      - name: Setup cross-compilation (Linux ARM64)
        if: matrix.platform.name == 'linux-aarch64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Build CLI
        run: cargo build -p scrape-cli --release --target ${{ matrix.platform.target }}

      - name: Create archive (Unix)
        if: matrix.platform.archive == 'tar.gz'
        run: |
          mkdir -p dist
          cp target/${{ matrix.platform.target }}/release/scrape dist/
          cd dist
          tar -czvf scrape-${{ matrix.platform.name }}.tar.gz scrape
          rm scrape

      - name: Create archive (Windows)
        if: matrix.platform.archive == 'zip'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item target/${{ matrix.platform.target }}/release/scrape.exe dist/
          Compress-Archive -Path dist/scrape.exe -DestinationPath dist/scrape-${{ matrix.platform.name }}.zip
          Remove-Item dist/scrape.exe

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: cli-${{ matrix.platform.name }}
          path: dist/scrape-*
          retention-days: 7

  # ==========================================================================
  # Build Python wheels for multiple platforms
  # ==========================================================================
  build-python:
    name: Build Python (${{ matrix.platform.name }})
    needs: validate
    runs-on: ${{ matrix.platform.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: auto

          - name: linux-aarch64
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            manylinux: auto

          - name: macos-x86_64
            os: macos-14
            target: x86_64-apple-darwin
            manylinux: auto

          - name: macos-aarch64
            os: macos-latest
            target: aarch64-apple-darwin
            manylinux: auto

          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            manylinux: auto

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          manylinux: ${{ matrix.platform.manylinux }}
          args: --release --out dist -m crates/scrape-py/Cargo.toml --find-interpreter
          sccache: false

      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-${{ matrix.platform.name }}
          path: dist/*.whl
          retention-days: 7

  # ==========================================================================
  # Build Python sdist
  # ==========================================================================
  build-python-sdist:
    name: Build Python sdist
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist -m crates/scrape-py/Cargo.toml

      - name: Upload sdist
        uses: actions/upload-artifact@v6
        with:
          name: wheels-sdist
          path: dist/*.tar.gz
          retention-days: 7

  # ==========================================================================
  # Publish to PyPI using Trusted Publishing (OIDC)
  # Setup: https://docs.pypi.org/trusted-publishers/adding-a-publisher/
  # ==========================================================================
  publish-pypi:
    name: Publish to PyPI
    needs: [validate, build-python, build-python-sdist]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment:
      name: pypi
      url: https://pypi.org/project/fast-scrape/
    permissions:
      id-token: write
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v7
        with:
          path: dist
          pattern: wheels-*
          merge-multiple: true

      - name: List wheels
        run: ls -lh dist/

      - name: Publish to PyPI (Trusted Publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true
          verbose: true

  # ==========================================================================
  # Build Node.js bindings for multiple platforms
  # ==========================================================================
  build-node:
    name: Build Node.js (${{ matrix.platform.name }})
    needs: validate
    runs-on: ${{ matrix.platform.os }}
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: linux-x64-gnu
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu

          - name: linux-x64-musl
            os: ubuntu-latest
            target: x86_64-unknown-linux-musl

          - name: linux-arm64-gnu
            os: ubuntu-latest
            target: aarch64-unknown-linux-gnu

          - name: linux-arm64-musl
            os: ubuntu-latest
            target: aarch64-unknown-linux-musl

          - name: darwin-x64
            os: macos-14
            target: x86_64-apple-darwin

          - name: darwin-arm64
            os: macos-latest
            target: aarch64-apple-darwin

          - name: win32-x64-msvc
            os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: node-${{ matrix.platform.name }}

      - uses: actions/setup-node@v6
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup cross-compilation (Linux ARM64)
        if: contains(matrix.platform.name, 'linux-arm64')
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Setup musl (Linux x64 musl)
        if: matrix.platform.name == 'linux-x64-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Setup musl (Linux ARM64 musl)
        if: matrix.platform.name == 'linux-arm64-musl'
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.11.0

      - name: Configure ARM64 musl linker
        if: matrix.platform.name == 'linux-arm64-musl'
        run: |
          sudo ln -sf $(which zig) /usr/local/bin/aarch64-linux-musl-gcc
          cat > /tmp/zigcc << 'ZIGEOF'
          #!/bin/sh
          exec zig cc -target aarch64-linux-musl "$@"
          ZIGEOF
          sudo mv /tmp/zigcc /usr/local/bin/aarch64-linux-musl-gcc
          sudo chmod +x /usr/local/bin/aarch64-linux-musl-gcc

      - name: Install dependencies
        working-directory: crates/scrape-node
        run: pnpm install --no-frozen-lockfile

      - name: Build
        working-directory: crates/scrape-node
        run: pnpm run build --target ${{ matrix.platform.target }}

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: node-${{ matrix.platform.name }}
          path: crates/scrape-node/*.node
          retention-days: 7

  # ==========================================================================
  # Publish to npm using Trusted Publishing (OIDC)
  # Setup: https://docs.npmjs.com/generating-provenance-statements
  # ==========================================================================
  publish-npm:
    name: Publish to npm
    needs: [validate, build-node]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: npm
      url: https://www.npmjs.com/package/@fast-scrape/node
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Download all bindings
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          pattern: node-*

      - name: Prepare platform packages
        run: |
          cd crates/scrape-node
          for platform in darwin-arm64 darwin-x64 linux-arm64-gnu linux-arm64-musl linux-x64-gnu linux-x64-musl win32-x64-msvc; do
            if [[ -d "../../artifacts/node-$platform" ]]; then
              cp ../../artifacts/node-$platform/*.node npm/$platform/ 2>/dev/null || true
              echo "Copied binaries to npm/$platform/"
              ls -la npm/$platform/
            fi
          done

      - name: Install dependencies
        working-directory: crates/scrape-node
        run: pnpm install --no-frozen-lockfile

      - name: Update npm for provenance
        run: npm install -g npm@latest

      - name: Publish platform packages
        working-directory: crates/scrape-node
        run: |
          for platform in darwin-arm64 darwin-x64 linux-arm64-gnu linux-arm64-musl linux-x64-gnu linux-x64-musl win32-x64-msvc; do
            if [[ -f "npm/$platform/package.json" ]] && ls npm/$platform/*.node 1>/dev/null 2>&1; then
              echo "Publishing @scrape-rs/$platform"
              cd npm/$platform
              npm publish --access public --provenance || true
              cd ../..
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish main package
        working-directory: crates/scrape-node
        run: pnpm publish --access public --no-git-checks --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ==========================================================================
  # Build and publish WASM
  # ==========================================================================
  publish-wasm:
    name: Publish WASM to npm
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: npm
      url: https://www.npmjs.com/package/@fast-scrape/wasm
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: wasm

      - uses: actions/setup-node@v6
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Install wasm-pack
        uses: taiki-e/install-action@v2
        with:
          tool: wasm-pack

      - name: Build WASM
        run: wasm-pack build crates/scrape-wasm --target web --release --scope fast-scrape

      - name: Fix package name
        run: |
          sed -i 's/"name": "@fast-scrape\/scrape-wasm"/"name": "@fast-scrape\/wasm"/' crates/scrape-wasm/pkg/package.json

      - name: Verify bundle size
        run: |
          WASM_SIZE=$(stat -c%s crates/scrape-wasm/pkg/scrape_wasm_bg.wasm 2>/dev/null || stat -f%z crates/scrape-wasm/pkg/scrape_wasm_bg.wasm)
          echo "WASM bundle size: $WASM_SIZE bytes"
          if [ "$WASM_SIZE" -gt 512000 ]; then
            echo "Warning: WASM bundle exceeds 500KB target"
          fi

      - name: Update npm for provenance
        run: npm install -g npm@latest

      - name: Publish to npm
        working-directory: crates/scrape-wasm/pkg
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ==========================================================================
  # Create GitHub Release
  # ==========================================================================
  github-release:
    name: Create GitHub Release
    needs: [validate, publish-crates, publish-pypi, publish-npm, publish-wasm, build-cli]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download Python wheels
        uses: actions/download-artifact@v7
        with:
          path: release-artifacts/python
          pattern: wheels-*
          merge-multiple: true

      - name: Download CLI binaries
        uses: actions/download-artifact@v7
        with:
          path: release-artifacts/cli
          pattern: cli-*
          merge-multiple: true

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Generate release notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"

          if git describe --tags --abbrev=0 HEAD^ 2>/dev/null; then
            git cliff --latest --strip header > RELEASE_NOTES.md
          else
            git cliff --unreleased --strip header > RELEASE_NOTES.md
          fi

          cat >> RELEASE_NOTES.md << EOF

          ## Installation

          ### CLI
          \`\`\`bash
          cargo install scrape-cli
          \`\`\`
          Or download pre-built binaries from the assets below.

          ### Rust
          \`\`\`toml
          [dependencies]
          scrape-core = "$VERSION"
          \`\`\`

          ### Python
          \`\`\`bash
          pip install fast-scrape==$VERSION
          \`\`\`

          ### Node.js
          \`\`\`bash
          npm install @fast-scrape/node@$VERSION
          \`\`\`

          ### WASM
          \`\`\`bash
          npm install @fast-scrape/wasm@$VERSION
          \`\`\`

          ## Published to

          - [crates.io (scrape-core)](https://crates.io/crates/scrape-core)
          - [crates.io (scrape-cli)](https://crates.io/crates/scrape-cli)
          - [PyPI](https://pypi.org/project/fast-scrape)
          - [npm](https://www.npmjs.com/package/@fast-scrape/node)
          - [npm (WASM)](https://www.npmjs.com/package/@fast-scrape/wasm)
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ needs.validate.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            release-artifacts/python/*.whl
            release-artifacts/cli/*.tar.gz
            release-artifacts/cli/*.zip
          token: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Final success check
  # ==========================================================================
  release-success:
    name: Release Success
    needs: [publish-crates, publish-pypi, publish-npm, publish-wasm, build-cli, github-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all release jobs
        run: |
          RESULTS=(
            "${{ needs.publish-crates.result }}"
            "${{ needs.publish-pypi.result }}"
            "${{ needs.publish-npm.result }}"
            "${{ needs.publish-wasm.result }}"
            "${{ needs.build-cli.result }}"
            "${{ needs.github-release.result }}"
          )

          for result in "${RESULTS[@]}"; do
            if [[ "$result" != "success" ]]; then
              echo "Release job failed: $result"
              exit 1
            fi
          done

          echo "All release jobs completed successfully!"
